<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>SQL questions on DataLemur (medium) | My New Hugo Site</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="Question
Users&rsquo;s third transaction - link
SELECT user_id, spend, transaction_date from (select user_id, spend, transaction_date, rank() over (partition by user_id order by transaction_date) as rnk from transactions) as r where r.rnk = 3 Question
Sending vs opening snaps - link
SELECT age_bucket, round(100.0 * CAST(sum(case when activity_type = &#39;send&#39; then time_spent else 0 end) as decimal) / cast(sum(case when activity_type in (&#39;send&#39;,&#39;open&#39;) then time_spent else 0 end) as decimal),2) as send_perc, round(100.">
    <meta name="generator" content="Hugo 0.123.8">
    
    
    
    
      <meta name="robots" content="noindex, nofollow">
    

    
<link rel="stylesheet" href="/ananke/css/main.min.css" >



    

    
      

    

    

    
      <link rel="canonical" href="https://example.org/posts/sql-interview-medium/">
    

    <meta property="og:title" content="SQL questions on DataLemur (medium)" />
<meta property="og:description" content="Question
Users&rsquo;s third transaction - link
SELECT user_id, spend, transaction_date from (select user_id, spend, transaction_date, rank() over (partition by user_id order by transaction_date) as rnk from transactions) as r where r.rnk = 3 Question
Sending vs opening snaps - link
SELECT age_bucket, round(100.0 * CAST(sum(case when activity_type = &#39;send&#39; then time_spent else 0 end) as decimal) / cast(sum(case when activity_type in (&#39;send&#39;,&#39;open&#39;) then time_spent else 0 end) as decimal),2) as send_perc, round(100." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://example.org/posts/sql-interview-medium/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-03-11T11:59:43-07:00" />
<meta property="article:modified_time" content="2024-03-11T11:59:43-07:00" />

<meta itemprop="name" content="SQL questions on DataLemur (medium)">
<meta itemprop="description" content="Question
Users&rsquo;s third transaction - link
SELECT user_id, spend, transaction_date from (select user_id, spend, transaction_date, rank() over (partition by user_id order by transaction_date) as rnk from transactions) as r where r.rnk = 3 Question
Sending vs opening snaps - link
SELECT age_bucket, round(100.0 * CAST(sum(case when activity_type = &#39;send&#39; then time_spent else 0 end) as decimal) / cast(sum(case when activity_type in (&#39;send&#39;,&#39;open&#39;) then time_spent else 0 end) as decimal),2) as send_perc, round(100."><meta itemprop="datePublished" content="2024-03-11T11:59:43-07:00" />
<meta itemprop="dateModified" content="2024-03-11T11:59:43-07:00" />
<meta itemprop="wordCount" content="1615">
<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/><meta name="twitter:title" content="SQL questions on DataLemur (medium)"/>
<meta name="twitter:description" content="Question
Users&rsquo;s third transaction - link
SELECT user_id, spend, transaction_date from (select user_id, spend, transaction_date, rank() over (partition by user_id order by transaction_date) as rnk from transactions) as r where r.rnk = 3 Question
Sending vs opening snaps - link
SELECT age_bucket, round(100.0 * CAST(sum(case when activity_type = &#39;send&#39; then time_spent else 0 end) as decimal) / cast(sum(case when activity_type in (&#39;send&#39;,&#39;open&#39;) then time_spent else 0 end) as decimal),2) as send_perc, round(100."/>

	
  </head>

  <body class="ma0 avenir bg-near-white">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="/" class="f3 fw2 hover-white no-underline white-90 dib">
      
        My New Hugo Site
      
    </a>
    <div class="flex-l items-center">
      

      
      
<div class="ananke-socials">
  
</div>

    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked ttu">
          
        Posts
      </aside>
      










  <div id="sharing" class="mt3 ananke-socials">
    
  </div>


      <h1 class="f1 athelas mt3 mb1">SQL questions on DataLemur (medium)</h1>
      
      
      
      <time class="f6 mv4 dib tracked" datetime="2024-03-11T11:59:43-07:00">March 11, 2024</time>
      

      
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><p><strong>Question</strong></p>
<blockquote>
<p>Users&rsquo;s third transaction - <a href="https://datalemur.com/questions/sql-third-transaction">link</a></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> user_id, spend, transaction_date
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">from</span> 
</span></span><span style="display:flex;"><span>  (<span style="color:#66d9ef">select</span> user_id, spend, transaction_date,
</span></span><span style="display:flex;"><span>    rank() over (partition <span style="color:#66d9ef">by</span> user_id <span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> transaction_date) <span style="color:#66d9ef">as</span> rnk
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">from</span> transactions) <span style="color:#66d9ef">as</span> r
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">where</span> r.rnk <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>
</span></span></code></pre></div><p><strong>Question</strong></p>
<blockquote>
<p>Sending vs opening snaps - <a href="https://datalemur.com/questions/time-spent-snaps">link</a></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> age_bucket,
</span></span><span style="display:flex;"><span>  round(<span style="color:#ae81ff">100</span>.<span style="color:#ae81ff">0</span> <span style="color:#f92672">*</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">CAST</span>(<span style="color:#66d9ef">sum</span>(<span style="color:#66d9ef">case</span> <span style="color:#66d9ef">when</span> activity_type <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;send&#39;</span> <span style="color:#66d9ef">then</span> time_spent <span style="color:#66d9ef">else</span> <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">end</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">as</span> decimal)
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">/</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">cast</span>(<span style="color:#66d9ef">sum</span>(<span style="color:#66d9ef">case</span> <span style="color:#66d9ef">when</span> activity_type <span style="color:#66d9ef">in</span> (<span style="color:#e6db74">&#39;send&#39;</span>,<span style="color:#e6db74">&#39;open&#39;</span>) <span style="color:#66d9ef">then</span> time_spent <span style="color:#66d9ef">else</span> <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">end</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">as</span> decimal),<span style="color:#ae81ff">2</span>) 
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">as</span> send_perc,
</span></span><span style="display:flex;"><span>  round(<span style="color:#ae81ff">100</span>.<span style="color:#ae81ff">0</span> <span style="color:#f92672">*</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">CAST</span>(<span style="color:#66d9ef">sum</span>(<span style="color:#66d9ef">case</span> <span style="color:#66d9ef">when</span> activity_type <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;open&#39;</span> <span style="color:#66d9ef">then</span> time_spent <span style="color:#66d9ef">else</span> <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">end</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">as</span> decimal)
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">/</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">cast</span>(<span style="color:#66d9ef">sum</span>(<span style="color:#66d9ef">case</span> <span style="color:#66d9ef">when</span> activity_type <span style="color:#66d9ef">in</span> (<span style="color:#e6db74">&#39;send&#39;</span>,<span style="color:#e6db74">&#39;open&#39;</span>) <span style="color:#66d9ef">then</span> time_spent <span style="color:#66d9ef">else</span> <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">end</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">as</span> decimal),<span style="color:#ae81ff">2</span>) 
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">as</span> open_perc
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">from</span> activities a <span style="color:#66d9ef">inner</span> <span style="color:#66d9ef">join</span> age_breakdown b
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">on</span> a.user_id <span style="color:#f92672">=</span> b.user_id
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">group</span> <span style="color:#66d9ef">by</span> age_bucket
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  
</span></span></code></pre></div><p><strong>Question</strong></p>
<blockquote>
<p>Tweets&rsquo; rolling average - <a href="https://datalemur.com/questions/rolling-average-tweets">link</a></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> <span style="color:#66d9ef">distinct</span> user_id, tweet_date,
</span></span><span style="display:flex;"><span>  round(
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">avg</span>(tweet_count) over (
</span></span><span style="display:flex;"><span>    partition <span style="color:#66d9ef">by</span> user_id 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> tweet_date 
</span></span><span style="display:flex;"><span>    range <span style="color:#66d9ef">between</span> 
</span></span><span style="display:flex;"><span>      interval <span style="color:#e6db74">&#39;2 days&#39;</span> preceding 
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">and</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">current</span> <span style="color:#66d9ef">row</span> 
</span></span><span style="display:flex;"><span>  ),<span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">as</span> rolling_avg_3d
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">FROM</span> tweets
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> user_id, tweet_date
</span></span></code></pre></div><p><strong>Question</strong></p>
<blockquote>
<p>Highest grossing items - <a href="https://datalemur.com/questions/sql-highest-grossing">link</a></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>;<span style="color:#66d9ef">with</span> MaxSpends <span style="color:#66d9ef">as</span>
</span></span><span style="display:flex;"><span>(<span style="color:#66d9ef">select</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">distinct</span> 
</span></span><span style="display:flex;"><span>  category,
</span></span><span style="display:flex;"><span>  product,
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">sum</span>(spend) over (partition <span style="color:#66d9ef">by</span> category, product) <span style="color:#66d9ef">as</span> total_spend
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">from</span> product_spend
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">where</span> <span style="color:#66d9ef">extract</span>(<span style="color:#e6db74">&#39;year&#39;</span> <span style="color:#66d9ef">from</span> transaction_date) <span style="color:#f92672">=</span> <span style="color:#ae81ff">2022</span>),
</span></span><span style="display:flex;"><span>Ranks <span style="color:#66d9ef">as</span>
</span></span><span style="display:flex;"><span>(
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">select</span> category, product, total_spend,
</span></span><span style="display:flex;"><span>    rank() over (partition <span style="color:#66d9ef">by</span> category <span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> total_spend <span style="color:#66d9ef">desc</span>) <span style="color:#66d9ef">as</span> rnk
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">from</span> MaxSpends
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">select</span> category, product, total_spend
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">from</span> Ranks
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">where</span> rnk <span style="color:#66d9ef">in</span> (<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>)
</span></span></code></pre></div><p><strong>Question</strong></p>
<blockquote>
<p>Signup activation rate - <a href="https://datalemur.com/questions/signup-confirmation-rate">link</a></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">select</span> 
</span></span><span style="display:flex;"><span>  round(<span style="color:#66d9ef">cast</span>(<span style="color:#66d9ef">sum</span>(<span style="color:#66d9ef">case</span> <span style="color:#66d9ef">when</span> t.signup_action<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Confirmed&#39;</span> 
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">then</span> <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">else</span> <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">end</span>) <span style="color:#66d9ef">as</span> decimal) <span style="color:#f92672">/</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">cast</span>(<span style="color:#66d9ef">count</span>(<span style="color:#66d9ef">distinct</span> e.email_id) <span style="color:#66d9ef">as</span> decimal),<span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">from</span> emails e <span style="color:#66d9ef">left</span> <span style="color:#66d9ef">join</span> texts t <span style="color:#66d9ef">on</span> e.email_id <span style="color:#f92672">=</span> 
</span></span><span style="display:flex;"><span>    t.email_id
</span></span></code></pre></div><p><strong>Question</strong></p>
<blockquote>
<p>Fill missing client data - <a href="https://datalemur.com/questions/fill-missing-product">link</a></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">with</span> Numbering <span style="color:#66d9ef">as</span> 
</span></span><span style="display:flex;"><span>(<span style="color:#66d9ef">select</span> 
</span></span><span style="display:flex;"><span>  product_id,
</span></span><span style="display:flex;"><span>  category,
</span></span><span style="display:flex;"><span>  name,
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">count</span>(category) over (<span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> product_id) <span style="color:#66d9ef">as</span> numbered_category
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">from</span> products),
</span></span><span style="display:flex;"><span>CategoryToNumber <span style="color:#66d9ef">as</span>
</span></span><span style="display:flex;"><span>(<span style="color:#66d9ef">select</span> numbered_category, category
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">from</span> Numbering
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">where</span> category <span style="color:#66d9ef">is</span> <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">null</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">select</span> product_id, r.category <span style="color:#66d9ef">as</span> category,
</span></span><span style="display:flex;"><span>  name 
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">from</span> Numbering l <span style="color:#66d9ef">inner</span> <span style="color:#66d9ef">join</span> CategoryToNumber r
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">on</span> l.numbered_category <span style="color:#f92672">=</span> r.numbered_category
</span></span></code></pre></div><p><strong>Question</strong></p>
<blockquote>
<p>Mean, median, mode - <a href="https://datalemur.com/questions/mean-median-mode">link</a></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">with</span> MostFrequent <span style="color:#66d9ef">AS</span>
</span></span><span style="display:flex;"><span>(
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">select</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">as</span> mean,
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">as</span> median,
</span></span><span style="display:flex;"><span>    email_count <span style="color:#66d9ef">as</span> <span style="color:#66d9ef">mode</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">from</span> inbox_stats
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">group</span> <span style="color:#66d9ef">by</span> email_count
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> <span style="color:#66d9ef">count</span>(<span style="color:#f92672">*</span>) <span style="color:#66d9ef">DESC</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">limit</span> <span style="color:#ae81ff">1</span> <span style="color:#75715e">-- give me the top one
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>),
</span></span><span style="display:flex;"><span>MeanMedian <span style="color:#66d9ef">as</span>
</span></span><span style="display:flex;"><span>(
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">select</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">sum</span>(email_count) <span style="color:#f92672">/</span> <span style="color:#66d9ef">count</span>(<span style="color:#f92672">*</span>) <span style="color:#66d9ef">as</span> mean,
</span></span><span style="display:flex;"><span>    percentile_cont(<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">5</span>) within <span style="color:#66d9ef">group</span> ( <span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> email_count <span style="color:#66d9ef">asc</span> ) <span style="color:#66d9ef">as</span> median,
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">as</span> <span style="color:#66d9ef">mode</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">from</span> inbox_stats
</span></span><span style="display:flex;"><span>),
</span></span><span style="display:flex;"><span>Combined <span style="color:#66d9ef">As</span>
</span></span><span style="display:flex;"><span>(
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> MostFrequent
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">UNION</span> <span style="color:#66d9ef">ALL</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> MeanMedian
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">select</span> <span style="color:#66d9ef">sum</span>(mean) <span style="color:#66d9ef">as</span> mean,
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">sum</span>(median) <span style="color:#66d9ef">as</span> median,
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">sum</span>(<span style="color:#66d9ef">mode</span>) <span style="color:#66d9ef">as</span> <span style="color:#66d9ef">mode</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">from</span> Combined
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- -- simpler version (after learning about mode() function)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">-- select 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">--   round(avg(email_count)) as mean,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">--   percentil_cont(0.5) within group (order by email_count) as median,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">--   mode() within group (order by email_count) as mode
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">-- from inbox_stats;
</span></span></span></code></pre></div><p><strong>Question</strong></p>
<blockquote>
<p>Pharmacy analytics 4 - <a href="https://datalemur.com/questions/top-drugs-sold">link</a></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">with</span> UnitsSold <span style="color:#66d9ef">as</span>
</span></span><span style="display:flex;"><span>(<span style="color:#66d9ef">select</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">distinct</span> 
</span></span><span style="display:flex;"><span>    manufacturer,
</span></span><span style="display:flex;"><span>    drug,
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">sum</span>(units_sold) over (partition <span style="color:#66d9ef">by</span> manufacturer, drug)
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">as</span> total_sold
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">from</span> pharmacy_sales
</span></span><span style="display:flex;"><span>),
</span></span><span style="display:flex;"><span>Ranked <span style="color:#66d9ef">AS</span>
</span></span><span style="display:flex;"><span>(
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">select</span> 
</span></span><span style="display:flex;"><span>    manufacturer,
</span></span><span style="display:flex;"><span>    drug,
</span></span><span style="display:flex;"><span>    rank() over (partition <span style="color:#66d9ef">by</span> manufacturer <span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> total_sold <span style="color:#66d9ef">desc</span>) 
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">as</span> rnk
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">from</span> UnitsSold
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">select</span> 
</span></span><span style="display:flex;"><span>  manufacturer,
</span></span><span style="display:flex;"><span>  drug <span style="color:#66d9ef">as</span> top_drugs
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">from</span> Ranked
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">where</span> rnk <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> manufacturer
</span></span></code></pre></div><p><strong>Question</strong></p>
<blockquote>
<p>Frequently purchased pairs - <a href="https://datalemur.com/questions/frequently-purchased-pairs">link</a></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">select</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">distinct</span> 
</span></span><span style="display:flex;"><span>  array_agg(product_id::text <span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> product_id) <span style="color:#66d9ef">as</span> combination
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">from</span> transactions
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">group</span> <span style="color:#66d9ef">by</span> transaction_id
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">having</span> <span style="color:#66d9ef">count</span>(<span style="color:#f92672">*</span>) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> combination
</span></span></code></pre></div><p><strong>Question</strong></p>
<blockquote>
<p>Super cloud customer - <a href="https://datalemur.com/questions/supercloud-customer">link</a></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">select</span> <span style="color:#66d9ef">distinct</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">c</span>.customer_id
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">from</span> customer_contracts <span style="color:#66d9ef">c</span> <span style="color:#66d9ef">inner</span> <span style="color:#66d9ef">join</span> products p
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">on</span> <span style="color:#66d9ef">c</span>.product_id <span style="color:#f92672">=</span> p.product_id
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">group</span> <span style="color:#66d9ef">by</span> <span style="color:#66d9ef">c</span>.customer_id
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">having</span> <span style="color:#66d9ef">count</span>(<span style="color:#66d9ef">distinct</span> product_category) 
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">=</span> (<span style="color:#66d9ef">select</span> <span style="color:#66d9ef">count</span>(<span style="color:#66d9ef">distinct</span> product_category) <span style="color:#66d9ef">from</span> products)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">ORDER</span> <span style="color:#66d9ef">BY</span> <span style="color:#66d9ef">c</span>.customer_id
</span></span></code></pre></div><p><strong>Question</strong></p>
<blockquote>
<p>Odd even measurements - <a href="https://datalemur.com/questions/odd-even-measurements">link</a></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">With</span> MeasurementNumber <span style="color:#66d9ef">as</span>
</span></span><span style="display:flex;"><span>(
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">select</span> measurement_id,
</span></span><span style="display:flex;"><span>    measurement_value,
</span></span><span style="display:flex;"><span>    date_trunc(<span style="color:#e6db74">&#39;day&#39;</span>, measurement_time) <span style="color:#66d9ef">as</span> measurement_day,
</span></span><span style="display:flex;"><span>    row_number() over (partition <span style="color:#66d9ef">by</span> date_part(<span style="color:#e6db74">&#39;day&#39;</span>, measurement_time)
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> measurement_time) <span style="color:#66d9ef">as</span> rn
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">from</span> measurements
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">select</span> measurement_day,
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">sum</span>(<span style="color:#66d9ef">case</span> <span style="color:#66d9ef">when</span> rn <span style="color:#f92672">%</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">then</span> measurement_value <span style="color:#66d9ef">else</span> <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">end</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">as</span> odd_sum,
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">sum</span>(<span style="color:#66d9ef">case</span> <span style="color:#66d9ef">when</span> rn <span style="color:#f92672">%</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">then</span> measurement_value <span style="color:#66d9ef">else</span> <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">end</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">as</span> even_sum
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">from</span> MeasurementNumber
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">group</span> <span style="color:#66d9ef">by</span> measurement_day
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> measurement_day
</span></span></code></pre></div><p><strong>Question</strong></p>
<blockquote>
<p>Booking ref source - <a href="https://datalemur.com/questions/booking-referral-source">link</a></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">with</span> FirstBooking <span style="color:#66d9ef">AS</span>
</span></span><span style="display:flex;"><span>(
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">select</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">distinct</span> 
</span></span><span style="display:flex;"><span>      user_id,
</span></span><span style="display:flex;"><span>      booking_id,
</span></span><span style="display:flex;"><span>      rank() over (partition <span style="color:#66d9ef">by</span> user_id <span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> booking_date) <span style="color:#66d9ef">as</span> rnk
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">from</span> bookings
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">select</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">distinct</span>
</span></span><span style="display:flex;"><span>  channel,
</span></span><span style="display:flex;"><span>  round(<span style="color:#ae81ff">100</span>.<span style="color:#ae81ff">0</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">count</span>(<span style="color:#f92672">*</span>) over (partition <span style="color:#66d9ef">by</span> channel)::decimal <span style="color:#f92672">/</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">count</span>(<span style="color:#f92672">*</span>) over ()::decimal) <span style="color:#66d9ef">as</span> first_booking_pct
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">from</span> FirstBooking f <span style="color:#66d9ef">inner</span> <span style="color:#66d9ef">join</span> booking_attribution a
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">on</span> f.booking_id <span style="color:#f92672">=</span> a.booking_id
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">where</span> rnk <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> first_booking_pct <span style="color:#66d9ef">DESC</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">limit</span> <span style="color:#ae81ff">1</span>
</span></span></code></pre></div><p><strong>Question</strong></p>
<blockquote>
<p>User shopping spree - <a href="https://datalemur.com/questions/amazon-shopping-spree">link</a></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">With</span> ConsecutiveDays <span style="color:#66d9ef">as</span>
</span></span><span style="display:flex;"><span>(
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">select</span> user_id,
</span></span><span style="display:flex;"><span>    transaction_date, 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#66d9ef">when</span> 
</span></span><span style="display:flex;"><span>      lead(transaction_date, <span style="color:#ae81ff">1</span>) over (partition <span style="color:#66d9ef">by</span> user_id
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> transaction_date)::date
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">-</span> transaction_date::date <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">then</span> <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">else</span> <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">as</span> ShoppedOnDay2,
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#66d9ef">when</span>
</span></span><span style="display:flex;"><span>      lead(transaction_date, <span style="color:#ae81ff">2</span>) over (partition <span style="color:#66d9ef">by</span> user_id
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> transaction_date)::date
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">-</span> transaction_date::date <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">then</span> <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">else</span> <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">as</span> ShoppedOnDay3
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">from</span> transactions
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">select</span> user_id <span style="color:#66d9ef">from</span>
</span></span><span style="display:flex;"><span>   ConsecutiveDays
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">where</span> ShoppedOnDay2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">and</span> ShoppedOnDay3 <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span></code></pre></div><p><strong>Question</strong></p>
<blockquote>
<p>Second ride delay - <a href="https://datalemur.com/questions/2nd-ride-delay">link</a></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>Ranked <span style="color:#66d9ef">as</span> 
</span></span><span style="display:flex;"><span>(
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">select</span> <span style="color:#66d9ef">distinct</span> 
</span></span><span style="display:flex;"><span>    user_id, 
</span></span><span style="display:flex;"><span>    ride_date,
</span></span><span style="display:flex;"><span>  row_number() over (PARTITION <span style="color:#66d9ef">BY</span> user_id <span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> ride_date) <span style="color:#66d9ef">as</span> rnk
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">from</span> rides
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">where</span> user_id <span style="color:#66d9ef">in</span> (<span style="color:#66d9ef">select</span> user_id <span style="color:#66d9ef">from</span> InTheMoment)
</span></span><span style="display:flex;"><span>),
</span></span><span style="display:flex;"><span>FirstRide <span style="color:#66d9ef">as</span>
</span></span><span style="display:flex;"><span>(
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">select</span> user_id,
</span></span><span style="display:flex;"><span>  ride_date
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">from</span> Ranked <span style="color:#66d9ef">where</span> rnk <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>),
</span></span><span style="display:flex;"><span>SecondRide <span style="color:#66d9ef">as</span>
</span></span><span style="display:flex;"><span>(
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">select</span> user_id,
</span></span><span style="display:flex;"><span>  ride_date
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">from</span> Ranked <span style="color:#66d9ef">where</span> rnk <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">select</span> 
</span></span><span style="display:flex;"><span>  round(<span style="color:#66d9ef">avg</span>(s.ride_date <span style="color:#f92672">-</span> f.ride_date),<span style="color:#ae81ff">2</span>) <span style="color:#66d9ef">as</span> average_delay<span style="color:#75715e">-- in days
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">from</span> FirstRide f <span style="color:#66d9ef">inner</span> <span style="color:#66d9ef">join</span> SecondRide s
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">on</span> f.user_id <span style="color:#f92672">=</span> s.user_id
</span></span></code></pre></div><p><strong>Question</strong></p>
<blockquote>
<p>Histogram of users and purchasew - <a href="https://datalemur.com/questions/histogram-users-purchases">link</a></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">with</span> LatestDateForEachUser <span style="color:#66d9ef">AS</span>
</span></span><span style="display:flex;"><span>(
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">select</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">distinct</span> 
</span></span><span style="display:flex;"><span>  user_id,
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">max</span>(transaction_date) over (partition <span style="color:#66d9ef">by</span> user_id) 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">as</span> max_transaction_date
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">from</span> user_transactions
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">select</span> <span style="color:#66d9ef">distinct</span>  
</span></span><span style="display:flex;"><span>  mt.max_transaction_date <span style="color:#66d9ef">as</span> transaction_date,
</span></span><span style="display:flex;"><span>  mt.user_id,
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">count</span>(<span style="color:#f92672">*</span>) 
</span></span><span style="display:flex;"><span>    over (partition <span style="color:#66d9ef">by</span> mt.user_id, u.transaction_date)
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">as</span> purchase_count
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">from</span> LatestDateForEachUser mt <span style="color:#66d9ef">inner</span> <span style="color:#66d9ef">join</span> 
</span></span><span style="display:flex;"><span>  user_transactions u <span style="color:#66d9ef">on</span> mt.user_id <span style="color:#f92672">=</span> u.user_id
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">and</span> u.transaction_date <span style="color:#f92672">=</span> max_transaction_date
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> max_transaction_date
</span></span><span style="display:flex;"><span>  
</span></span></code></pre></div><p><strong>Question</strong></p>
<blockquote>
<p>Off-topic UGC posts on Google - <a href="https://datalemur.com/questions/off-topic-maps-ugc">link</a></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">with</span> places 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">as</span> (
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">select</span> 
</span></span><span style="display:flex;"><span>  place_category,
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">count</span>(<span style="color:#f92672">*</span>) <span style="color:#66d9ef">as</span> content_count
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">from</span> place_info p <span style="color:#66d9ef">inner</span> <span style="color:#66d9ef">join</span> maps_ugc_review r
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">on</span> r.place_id <span style="color:#f92672">=</span> p.place_id 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">and</span> content_tag <span style="color:#66d9ef">is</span> <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">null</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">and</span> content_tag <span style="color:#66d9ef">ilike</span> <span style="color:#e6db74">&#39;%Off-topic%&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">group</span> <span style="color:#66d9ef">by</span> place_category
</span></span><span style="display:flex;"><span>),
</span></span><span style="display:flex;"><span>top_places <span style="color:#66d9ef">AS</span>
</span></span><span style="display:flex;"><span>(
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">select</span> place_category,
</span></span><span style="display:flex;"><span>  content_count,
</span></span><span style="display:flex;"><span>  rank() over (<span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> content_count <span style="color:#66d9ef">desc</span>) <span style="color:#66d9ef">as</span> top_place
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">from</span> places
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">select</span> place_category <span style="color:#66d9ef">as</span> off_topic_places
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">from</span> top_places
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">where</span> top_place <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span></code></pre></div><p><strong>Question</strong></p>
<blockquote>
<p>Alibaba compressed mean - <a href="https://datalemur.com/questions/alibaba-compressed-mode">link</a></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">with</span> MaxFreq <span style="color:#66d9ef">as</span>
</span></span><span style="display:flex;"><span>(<span style="color:#66d9ef">select</span> <span style="color:#66d9ef">max</span>(order_occurrences) <span style="color:#66d9ef">as</span> max_occurrences
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">from</span> items_per_order
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">select</span> 
</span></span><span style="display:flex;"><span>  item_count <span style="color:#66d9ef">as</span> <span style="color:#66d9ef">mode</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">from</span> MaxFreq mf <span style="color:#66d9ef">inner</span> <span style="color:#66d9ef">join</span> items_per_order i
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">on</span> mf.max_occurrences <span style="color:#f92672">=</span> i.order_occurrences
</span></span></code></pre></div><p><strong>Question</strong></p>
<blockquote>
<p>Card launch success - <a href="https://datalemur.com/questions/card-launch-success">link</a></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">With</span> IssueMonthRanked <span style="color:#66d9ef">AS</span>
</span></span><span style="display:flex;"><span>(
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">select</span> 
</span></span><span style="display:flex;"><span>    card_name,
</span></span><span style="display:flex;"><span>    issued_amount,
</span></span><span style="display:flex;"><span>    issue_year,
</span></span><span style="display:flex;"><span>    issue_month,
</span></span><span style="display:flex;"><span>    row_number() over (partition <span style="color:#66d9ef">by</span> card_name
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> issue_year, issue_month 
</span></span><span style="display:flex;"><span>      ) rn
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">from</span> monthly_cards_issued
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">select</span> card_name, issued_amount
</span></span><span style="display:flex;"><span>  rn
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">from</span> IssueMonthRanked
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">where</span> rn <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> issued_amount <span style="color:#66d9ef">desc</span>
</span></span></code></pre></div><p><strong>Question</strong></p>
<blockquote>
<p>International call percentage - <a href="https://datalemur.com/questions/international-call-percentage">link</a></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">with</span> CallerCountry
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">AS</span>
</span></span><span style="display:flex;"><span>(
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">select</span> 
</span></span><span style="display:flex;"><span>    p.caller_id, 
</span></span><span style="display:flex;"><span>    p.receiver_id,
</span></span><span style="display:flex;"><span>    country_id <span style="color:#66d9ef">as</span> caller_country
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">from</span> phone_calls p <span style="color:#66d9ef">inner</span> <span style="color:#66d9ef">join</span> phone_info i
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">on</span> p.caller_id <span style="color:#f92672">=</span> i.caller_id
</span></span><span style="display:flex;"><span>),
</span></span><span style="display:flex;"><span>CallerAndReceiverCountry <span style="color:#66d9ef">as</span>
</span></span><span style="display:flex;"><span>(
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">select</span> <span style="color:#66d9ef">c</span>.caller_id,
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">c</span>.receiver_id,
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">c</span>.caller_country,
</span></span><span style="display:flex;"><span>  i.country_id <span style="color:#66d9ef">as</span> receiver_country
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">from</span> CallerCountry <span style="color:#66d9ef">c</span> <span style="color:#66d9ef">inner</span> <span style="color:#66d9ef">join</span> phone_info i
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">on</span> <span style="color:#66d9ef">c</span>.receiver_id <span style="color:#f92672">=</span> i.caller_id
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">select</span> 
</span></span><span style="display:flex;"><span>  round(<span style="color:#ae81ff">100</span>.<span style="color:#ae81ff">0</span> <span style="color:#f92672">*</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">cast</span>(<span style="color:#66d9ef">sum</span>(<span style="color:#66d9ef">case</span> <span style="color:#66d9ef">when</span> caller_country <span style="color:#f92672">&lt;&gt;</span> receiver_country 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">then</span> <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">else</span> <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">end</span>) <span style="color:#66d9ef">as</span> decimal) 
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">/</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">cast</span>(<span style="color:#66d9ef">count</span>(<span style="color:#f92672">*</span>) <span style="color:#66d9ef">as</span> decimal), <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">from</span> CallerAndReceiverCountry
</span></span></code></pre></div><p><strong>Question</strong></p>
<blockquote>
<p>LinkedIn power creators (2) - <a href="https://datalemur.com/questions/linkedin-power-creators-part2">link</a></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">with</span> CompanyFollowers <span style="color:#66d9ef">as</span> 
</span></span><span style="display:flex;"><span>(<span style="color:#66d9ef">SELECT</span>
</span></span><span style="display:flex;"><span>    employees.personal_profile_id,
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">MAX</span>(pages.followers) <span style="color:#66d9ef">AS</span> max_company_followers
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">FROM</span> employee_company <span style="color:#66d9ef">AS</span> employees 
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">LEFT</span> <span style="color:#66d9ef">JOIN</span> company_pages <span style="color:#66d9ef">AS</span> pages
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">ON</span> employees.company_id <span style="color:#f92672">=</span> pages.company_id  
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">GROUP</span> <span style="color:#66d9ef">BY</span> employees.personal_profile_id
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">select</span> 
</span></span><span style="display:flex;"><span>  profile_id
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">from</span> CompanyFollowers <span style="color:#66d9ef">c</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">inner</span> <span style="color:#66d9ef">join</span> personal_profiles p
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">on</span> <span style="color:#66d9ef">c</span>.personal_profile_id <span style="color:#f92672">=</span> p.profile_id
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">where</span> p.followers <span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">c</span>.max_company_followers
</span></span></code></pre></div><p><strong>Question</strong></p>
<blockquote>
<p>Money transfer relationship - <a href="https://datalemur.com/questions/money-transfer-relationships">link</a></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">with</span> Pairs <span style="color:#66d9ef">as</span>
</span></span><span style="display:flex;"><span>(
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">select</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">distinct</span> 
</span></span><span style="display:flex;"><span>    p.payer_id <span style="color:#66d9ef">as</span> payer_id, 
</span></span><span style="display:flex;"><span>    p.recipient_id <span style="color:#66d9ef">as</span> recipient_id,
</span></span><span style="display:flex;"><span>    r.payer_id right_payerid
</span></span><span style="display:flex;"><span>    , r.recipient_id right_recipient_id
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span>
</span></span><span style="display:flex;"><span>payments p <span style="color:#66d9ef">inner</span> <span style="color:#66d9ef">join</span> payments r
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">on</span> p.payer_id <span style="color:#f92672">=</span> r.recipient_id
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">and</span> p.recipient_id <span style="color:#f92672">=</span> r.payer_id
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">select</span> <span style="color:#66d9ef">count</span>(<span style="color:#f92672">*</span>) <span style="color:#66d9ef">as</span> unique_relationships
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">from</span> Pairs p
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">where</span> payer_id <span style="color:#f92672">&lt;</span> recipient_id
</span></span></code></pre></div><p><strong>Question</strong></p>
<blockquote>
<p>User session activity - <a href="https://datalemur.com/questions/user-session-activity">link</a></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">with</span> TotalDuration <span style="color:#66d9ef">AS</span>
</span></span><span style="display:flex;"><span>(
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">select</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">distinct</span> user_id, session_type,
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">sum</span>(duration) over (partition <span style="color:#66d9ef">by</span> user_id, 
</span></span><span style="display:flex;"><span>    session_type 
</span></span><span style="display:flex;"><span>    ) total_duration
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">from</span> sessions
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">where</span> start_date <span style="color:#66d9ef">BETWEEN</span> <span style="color:#e6db74">&#39;2022-01-01&#39;</span>::<span style="color:#66d9ef">timestamp</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">and</span> <span style="color:#e6db74">&#39;2022-02-01&#39;</span>::<span style="color:#66d9ef">timestamp</span>
</span></span><span style="display:flex;"><span>),
</span></span><span style="display:flex;"><span>Ranked <span style="color:#66d9ef">as</span> 
</span></span><span style="display:flex;"><span>(
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">select</span> 
</span></span><span style="display:flex;"><span>    user_id,
</span></span><span style="display:flex;"><span>    session_type,
</span></span><span style="display:flex;"><span>    rank() over (partition <span style="color:#66d9ef">by</span> session_type 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> total_duration <span style="color:#66d9ef">desc</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">as</span> ranking
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">from</span> TotalDuration
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> Ranked
</span></span></code></pre></div><p><strong>Question</strong></p>
<blockquote>
<p>First transaction on Etsy - <a href="https://datalemur.com/questions/sql-first-transaction">link</a></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">with</span> Ranked <span style="color:#66d9ef">AS</span>
</span></span><span style="display:flex;"><span>(
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">select</span> <span style="color:#66d9ef">distinct</span> 
</span></span><span style="display:flex;"><span>    user_id,
</span></span><span style="display:flex;"><span>    spend,
</span></span><span style="display:flex;"><span>    transaction_date,
</span></span><span style="display:flex;"><span>    row_number() over (partition <span style="color:#66d9ef">by</span> user_id <span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> 
</span></span><span style="display:flex;"><span>    transaction_date) <span style="color:#66d9ef">as</span> rnk
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">from</span> user_transactions 
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">select</span> <span style="color:#66d9ef">count</span>(<span style="color:#f92672">*</span>) <span style="color:#66d9ef">from</span> Ranked
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">where</span> spend <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">50</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">and</span> rnk <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span></code></pre></div><p><strong>Question</strong></p>
<blockquote>
<p>Email table transformation - <a href="https://datalemur.com/questions/email-table-transformation">link</a></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">with</span> Pivoted <span style="color:#66d9ef">as</span>
</span></span><span style="display:flex;"><span>(<span style="color:#66d9ef">select</span> 
</span></span><span style="display:flex;"><span>  user_id,
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">case</span> <span style="color:#66d9ef">when</span> email_type <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;personal&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">then</span> email <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">NULL</span> <span style="color:#66d9ef">END</span> <span style="color:#66d9ef">as</span> personal,
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">case</span> <span style="color:#66d9ef">when</span> email_type <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;business&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">then</span> email <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">NULL</span> <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">as</span> business,
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">case</span> <span style="color:#66d9ef">when</span> email_type <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;recovery&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">then</span> email <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">NULL</span> <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">as</span> recovery
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">from</span> users)
</span></span><span style="display:flex;"><span>, Arrays <span style="color:#66d9ef">as</span>
</span></span><span style="display:flex;"><span>(<span style="color:#66d9ef">select</span> user_id,
</span></span><span style="display:flex;"><span>array_agg(personal <span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> personal) <span style="color:#66d9ef">as</span> personal,
</span></span><span style="display:flex;"><span>array_agg(business <span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> business) <span style="color:#66d9ef">as</span> business,
</span></span><span style="display:flex;"><span>array_agg(recovery <span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> recovery) <span style="color:#66d9ef">as</span> recovery
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">from</span> Pivoted
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">group</span> <span style="color:#66d9ef">by</span> user_id)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">select</span> user_id,
</span></span><span style="display:flex;"><span>  personal[<span style="color:#ae81ff">1</span>] <span style="color:#66d9ef">as</span> personal,
</span></span><span style="display:flex;"><span>  business[<span style="color:#ae81ff">1</span>] <span style="color:#66d9ef">as</span> business,
</span></span><span style="display:flex;"><span>  recovery[<span style="color:#ae81ff">1</span>] <span style="color:#66d9ef">as</span> recovery
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">from</span> Arrays
</span></span><span style="display:flex;"><span>  
</span></span></code></pre></div><p><strong>Question</strong></p>
<blockquote>
<p>Photoshop revenue analysis - <a href="https://datalemur.com/questions/photoshop-revenue-analysis">link</a></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">select</span> 
</span></span><span style="display:flex;"><span>    customer_id,
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">sum</span>(<span style="color:#66d9ef">case</span> <span style="color:#66d9ef">when</span> product <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Photoshop&#39;</span> <span style="color:#66d9ef">then</span> <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">else</span> revenue <span style="color:#66d9ef">end</span>) <span style="color:#66d9ef">as</span> revenue
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">from</span> adobe_transactions
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">where</span> customer_id <span style="color:#75715e">-- only those that purchased Photoshop
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">in</span> (
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">select</span> <span style="color:#66d9ef">distinct</span> customer_id
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">from</span> adobe_transactions
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">where</span> product <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Photoshop&#39;</span>
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">group</span> <span style="color:#66d9ef">by</span> customer_id
</span></span></code></pre></div><p><strong>Question</strong></p>
<blockquote>
<p>Consulting bench time - <a href="https://datalemur.com/questions/consulting-bench-time">link</a></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">with</span> Durations <span style="color:#66d9ef">AS</span>
</span></span><span style="display:flex;"><span>(
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">select</span> 
</span></span><span style="display:flex;"><span>      s.employee_id,
</span></span><span style="display:flex;"><span>      e.job_id,
</span></span><span style="display:flex;"><span>      (end_date <span style="color:#f92672">-</span> start_date <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">as</span> duration_days
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">from</span> staffing s
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">inner</span> <span style="color:#66d9ef">join</span> consulting_engagements e <span style="color:#66d9ef">on</span>
</span></span><span style="display:flex;"><span>    s.job_id <span style="color:#f92672">=</span> e.job_id
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">where</span> s.is_consultant <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;true&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">and</span> date_part(<span style="color:#e6db74">&#39;year&#39;</span>, e.start_date) <span style="color:#f92672">=</span> <span style="color:#ae81ff">2021</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">select</span> employee_id,
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">365</span> <span style="color:#f92672">-</span> <span style="color:#66d9ef">sum</span>(duration_days) <span style="color:#66d9ef">as</span> bench_days
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">from</span> Durations
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">group</span> <span style="color:#66d9ef">by</span> employee_id
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> employee_id
</span></span></code></pre></div><p><strong>Question</strong></p>
<blockquote>
<p>Sales team compensation - <a href="https://datalemur.com/questions/sales-team-compensation">link</a></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">with</span> TotalDeals
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">AS</span>
</span></span><span style="display:flex;"><span>(
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">select</span> employee_id,
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">sum</span>(deal_size) <span style="color:#66d9ef">as</span> total_sales
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">from</span> deals
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">group</span> <span style="color:#66d9ef">by</span> employee_id
</span></span><span style="display:flex;"><span>),
</span></span><span style="display:flex;"><span>Temp <span style="color:#66d9ef">as</span>
</span></span><span style="display:flex;"><span>(
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">select</span> d.employee_id, 
</span></span><span style="display:flex;"><span>    d.base,
</span></span><span style="display:flex;"><span>    d.commission, 
</span></span><span style="display:flex;"><span>    d.quota, 
</span></span><span style="display:flex;"><span>    d.accelerator,
</span></span><span style="display:flex;"><span>    t.total_sales,
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#66d9ef">when</span> (t.total_sales <span style="color:#f92672">-</span> quota) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">then</span> (t.total_sales <span style="color:#f92672">-</span> quota) <span style="color:#66d9ef">else</span> <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">as</span> excess
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">from</span> TotalDeals t 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">inner</span> <span style="color:#66d9ef">join</span> employee_contract d
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">on</span> t.employee_id <span style="color:#f92672">=</span> d.employee_id
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">select</span> 
</span></span><span style="display:flex;"><span>  employee_id,
</span></span><span style="display:flex;"><span>  base <span style="color:#f92672">+</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#66d9ef">when</span> 
</span></span><span style="display:flex;"><span>      excess <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">then</span> 
</span></span><span style="display:flex;"><span>        (commission <span style="color:#f92672">*</span> quota)
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">+</span> 
</span></span><span style="display:flex;"><span>        commission <span style="color:#f92672">*</span> excess <span style="color:#f92672">*</span> accelerator
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">ELSE</span>
</span></span><span style="display:flex;"><span>        (commission <span style="color:#f92672">*</span> total_sales)
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">as</span> total_compensation
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">from</span> Temp
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> total_compensation <span style="color:#66d9ef">desc</span>, employee_id 
</span></span></code></pre></div><p><strong>Question</strong></p>
<blockquote>
<p>Invalid search pct - <a href="https://datalemur.com/questions/invalid-search-pct">link</a></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span>
</span></span><span style="display:flex;"><span>  country,
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">sum</span>(num_search) <span style="color:#66d9ef">as</span> total_search,
</span></span><span style="display:flex;"><span>  round(<span style="color:#ae81ff">100</span>.<span style="color:#ae81ff">0</span> <span style="color:#f92672">*</span> 
</span></span><span style="display:flex;"><span>    (<span style="color:#66d9ef">sum</span>(num_search <span style="color:#f92672">*</span> invalid_result_pct::decimal <span style="color:#f92672">/</span> <span style="color:#ae81ff">100</span>.<span style="color:#ae81ff">0</span>)::decimal
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">/</span><span style="color:#66d9ef">sum</span>(num_search)::decimal),<span style="color:#ae81ff">2</span>) <span style="color:#66d9ef">as</span> invalid_searches_pct
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">from</span> search_category
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">where</span> 
</span></span><span style="display:flex;"><span>(num_search <span style="color:#66d9ef">is</span> <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">NULL</span> <span style="color:#66d9ef">and</span> invalid_result_pct <span style="color:#66d9ef">is</span> <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">NULL</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">group</span> <span style="color:#66d9ef">by</span> country
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> country, total_search, invalid_searches_pct
</span></span></code></pre></div><ul class="pa0">
  
</ul>
<div class="mt6 instapaper_ignoref">
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://example.org/" >
    &copy;  My New Hugo Site 2024 
  </a>
    <div>
<div class="ananke-socials">
  
</div>
</div>
  </div>
</footer>

  </body>
</html>
